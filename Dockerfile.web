FROM node:20-alpine AS builder
WORKDIR /workspace

# Install workspace dependencies (CI-friendly)
COPY package*.json ./
RUN npm ci --no-audit --no-fund

# Copy the rest of the workspace (Nx will only use what's needed)
COPY . .

# Build Angular app
RUN npx nx build web --configuration=production

# Runtime image: Nginx, non-root
FROM nginx:1.27-alpine AS runtime
WORKDIR /usr/share/nginx/html

# Copy Nginx SPA config
COPY ops/nginx/web.conf /etc/nginx/conf.d/default.conf

# Copy compiled app
COPY --from=builder /workspace/dist/web/browser .

# Use nginx user (non-root). Ensure permissions
RUN chown -R nginx:nginx /usr/share/nginx/html
USER nginx

EXPOSE 80

HEALTHCHECK --interval=30s --timeout=3s --retries=3 CMD wget -qO- http://127.0.0.1/ || exit 1

CMD ["nginx", "-g", "daemon off;"]


